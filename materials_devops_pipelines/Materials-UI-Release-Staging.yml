---
trigger: none
pr: none

resources:
  pipelines:
    - pipeline: MaterialsBuild
      source: Cps-Materials-UI-Staging-Build
      trigger:
        branches:
          include:
            - refs/heads/development
        stages:
          - Publish_Artifacts

pool:
  name: $(stg-build-agent)

parameters:
- name: TF_Apply
  displayName: Apply TF change
  type: boolean
  default: true

variables:
  - name: majorMinorVersion
    value: 1.0
  - name: semanticVersion 
    value: $[counter(variables['majorMinorVersion'], 1)]
  - name: targetLabel 
    value: STG
  - group: materials-kv-stg-terraform
  - group: materials-global

stages:

## Apply Terraform ##                 
  - stage: Apply_Terraform_Staging
    displayName: Apply Materials Terraform
    jobs:  

      - deployment: Wait_For_Running_Builds
        environment: "Materials_Staging"
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates\task_wait-for-running-releases.yml
                  parameters:
                    devOpsPatToken: $(System.AccessToken)

      - deployment: CI_Deploy_Materials_Terraform
        condition: succeeded()
        dependsOn: Wait_For_Running_Builds
        displayName: Apply Main Terraform
        environment: "Materials_Staging"
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates/task_get-credentials.yml
                  parameters:
                    azureSubscription: $(staging-azure-service-connection)

                - template: templates/task_apply-terraform.yml
                  parameters:
                    targetBuild: "MaterialsBuild"
                    targetTerraformArtifact: $(targetTerraformArtifact)
                    targetPlanName: "stg"
                    terraformStorageAccount: $(staging-terraform-storage-account)
                    terraformContainerName: $(materials-terraform-container-name)
                    terraformStateKey: $(terraform-key)
                    terraformStateResourceGroup: $(terraform-resource-group)
                    armClientId: $(clientId)
                    armClientSecret: $(clientSecret)
                    armTenantId: $(tenantId)
                    armSubscriptionId: $(subscriptionId)
                    TF_Apply: ${{ parameters.TF_Apply }}
                    terraformVersion: $(terraform-version)

## UI Deployment ##
  - stage: Apply_UI_Staging
    displayName: Deploy Materials UI
    condition: succeeded()
    dependsOn: Apply_Terraform_Staging
    jobs:

      - deployment: CI_Deploy_Materials_UI
        condition: succeeded()
        displayName: Apply UI SPA
        environment: "Materials_Staging"
        workspace:
          clean: all
        strategy:
          runOnce:
            deploy:
              steps:
                - template: templates\task_deploy-spa.yml
                  parameters:
                    targetBuild: "MaterialsBuild"
                    targetLabel: $(targetLabel)
                    azureSubscription: $(staging-azure-subscription)
                    WebAppName: $(staging-spa-resource-name)
                    resourceGroupName: "rg-materials-${{ lower(variables.targetLabel) }}-uk"
                    BuildArtifactName: $(targetUIArtifact) 
                    SlotName: "staging1"

  - stage: Swap_Slots
    displayName: Swap Slots
    dependsOn: Apply_UI_Staging
    condition: succeeded()
    jobs:
      - template: templates/job_swap-slots.yml
        parameters:
            azureSubscription: $(staging-azure-service-connection)
            resourceGroupName: "rg-materials-${{ lower(variables.targetLabel) }}-uk"
            AppServiceName: $(staging-spa-resource-name)

            

# TBC requires further testing once site is live
  # - stage: Test_UI
  #   displayName: Test UI
  #   jobs:
  #   - job:
  #     steps:       
  #     - task: PowerShell@2
  #       displayName: 'Checking ${{ parameters.targetLabel }} ${{ parameters.targetAppName }} status'
  #       inputs:
  #         failOnStderr: true
  #         targetType: 'filePath'
  #         filePath: $(Pipeline.Workspace)/${{ parameters.targetBuild }}/materials-script-files/InvokeRequestWithRetry.ps1
  #         arguments: > # Use this to avoid newline characters in multi-line string
  #           -URI "##########"
  #           -Method "GET"
  #           -SuccessTextContent $(resources.pipeline.MaterialsBuild.runName)
  #           -Retries "15"
  #           -SecondsDelay "30"
  #           -TimeoutSec "60"