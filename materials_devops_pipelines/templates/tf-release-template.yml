steps:
  # Install Terraform based on version variable
  - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
    displayName: Terraform > Install
    inputs:
      terraformVersion: $(terraform-version)

  - bash:  | 
      terraform init  \
      -backend-config="storage_account_name=${TF_STATE_ACCOUNT_NAME}" \
      -backend-config="container_name=${TF_STATE_CONTAINER_NAME}" \
      -backend-config="key=${TF_STATE_KEY}" \
      -backend-config="resource_group_name=${TF_RESOURCE_GROUP_NAME}" \
    displayName: Terraform > Init
    workingDirectory: '$(Pipeline.Workspace)/$(pipelineName)/$(tfBuildFolder)/'
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      TF_STATE_ACCOUNT_NAME: $(Storage-Account-Name)
      TF_STATE_CONTAINER_NAME: $(Storage-Account-Container-Name)
      TF_RESOURCE_GROUP_NAME: $(Storage-Resource-Group-Name)
      TF_STATE_KEY: $(Storage-Account-Key)

  - bash: |
      terraform plan -input=false -out=$(envVar).tfplan -var-file="./environments/$(envVar).tfvars"
    displayName: 'Terraform > Write $(envVar) Plan'
    workingDirectory: '$(Pipeline.Workspace)/$(pipelineName)/$(tfBuildFolder)'
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID) 

  # Terraform Apply
  - bash: |
      terraform apply -auto-approve $(envVar).tfplan 
    displayName: 'Terraform > Apply to $(envVar)'
    condition: eq(${{ parameters.TF_Apply }}, true)
    workingDirectory: '$(Pipeline.Workspace)/$(pipelineName)/$(tfBuildFolder)/'
    env:
      ARM_CLIENT_ID: $(ARM_CLIENT_ID)
      ARM_CLIENT_SECRET: $(ARM_CLIENT_SECRET)
      ARM_TENANT_ID: $(ARM_TENANT_ID)
      ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)